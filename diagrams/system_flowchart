digraph SystemFlowchart {
    rankdir=TB;
    node [shape=box, style=rounded, fontname="Arial"];
    edge [fontname="Arial", fontsize=10];
    
    // Title
    labelloc="t";
    label="AirSense Guardian - System Flowchart";
    fontsize=16;
    fontname="Arial Bold";
    
    // Start
    Start [label="User Opens\nApplication", fillcolor=lightgreen, shape=ellipse];
    
    // Frontend Initialization
    FrontendInit [label="React Frontend\nLoads", fillcolor=lightblue];
    DefaultLocation [label="Default Location:\nDelhi (28.6139, 77.2090)", fillcolor=lightblue];
    
    // User Input
    UserInput [label="User Input\n(Latitude, Longitude)", fillcolor=lightyellow, shape=diamond];
    
    // API Request
    APIRequest [label="API Request to\nFlask Backend\n(/api/aqi/current)", fillcolor=lightcoral];
    
    // Data Fetching
    subgraph cluster_data_fetch {
        label="Data Fetching";
        style=filled;
        color=lightcyan;
        
        FetchAQI [label="Fetch AQI Data\n(OpenAQ API)", fillcolor=lightcyan];
        FetchWeather [label="Fetch Weather Data\n(OpenWeatherMap)", fillcolor=lightcyan];
        EstimateTraffic [label="Estimate Traffic Density\n(Time-based)", fillcolor=lightcyan];
    }
    
    // Model Processing
    subgraph cluster_models {
        label="ML Models Processing";
        style=filled;
        color=lightgreen;
        
        SourceAttr [label="Source Attribution\n(Traffic, Industry,\nOpen Burning, Other)", fillcolor=lightgreen];
        Predictor [label="AQI Predictor\n(Random Forest)\nPredict Next 3-6 Hours", fillcolor=lightgreen];
        ActionEngine [label="Action Engine\nGenerate Recommendations\nwith Impact Estimates", fillcolor=lightgreen];
    }
    
    // Alert Generation
    AlertCheck [label="Check AQI Levels\nGenerate Alerts", fillcolor=orange, shape=diamond];
    
    // Response Assembly
    ResponseAssembly [label="Assemble JSON Response\n(AQI, Weather, Sources,\nPredictions, Actions, Alerts)", fillcolor=lightpink];
    
    // Frontend Display
    subgraph cluster_display {
        label="Frontend Display";
        style=filled;
        color=lavender;
        
        AQICard [label="AQI Card\n(Current AQI, Pollutants)", fillcolor=lavender];
        SourceViz [label="Source Attribution\nVisualization", fillcolor=lavender];
        PredictionsChart [label="Predictions Chart\n(Interactive Line Chart)", fillcolor=lavender];
        ActionCards [label="Action Cards\n(Recommendations)", fillcolor=lavender];
        AlertsPanel [label="Alerts Panel\n(Real-time Warnings)", fillcolor=lavender];
    }
    
    // User Actions
    UserActions [label="User Actions:\n- Change Location\n- View Details\n- Refresh Data", fillcolor=lightyellow, shape=diamond];
    
    // Refresh Loop
    Refresh [label="Auto-refresh\nEvery 5 minutes", fillcolor=lightblue];
    
    // Error Handling
    ErrorHandling [label="Error Handling\nFallback to Mock Data", fillcolor=red, shape=diamond];
    
    // Flow connections
    Start -> FrontendInit;
    FrontendInit -> DefaultLocation;
    DefaultLocation -> UserInput;
    UserInput -> APIRequest [label="Submit"];
    
    APIRequest -> FetchAQI;
    APIRequest -> FetchWeather;
    APIRequest -> EstimateTraffic;
    
    FetchAQI -> SourceAttr;
    FetchWeather -> SourceAttr;
    EstimateTraffic -> SourceAttr;
    
    FetchAQI -> Predictor;
    FetchWeather -> Predictor;
    EstimateTraffic -> Predictor;
    
    SourceAttr -> ActionEngine;
    Predictor -> ActionEngine;
    
    ActionEngine -> AlertCheck;
    AlertCheck -> ResponseAssembly;
    
    ResponseAssembly -> AQICard;
    ResponseAssembly -> SourceViz;
    ResponseAssembly -> PredictionsChart;
    ResponseAssembly -> ActionCards;
    ResponseAssembly -> AlertsPanel;
    
    AQICard -> UserActions;
    SourceViz -> UserActions;
    PredictionsChart -> UserActions;
    ActionCards -> UserActions;
    AlertsPanel -> UserActions;
    
    UserActions -> APIRequest [label="New Request"];
    UserActions -> Refresh [label="Auto"];
    Refresh -> APIRequest;
    
    // Error paths
    FetchAQI -> ErrorHandling [label="API Error", style=dashed, color=red];
    FetchWeather -> ErrorHandling [label="API Error", style=dashed, color=red];
    ErrorHandling -> ResponseAssembly [label="Use Mock Data", style=dashed, color=red];
    
    // Styling
    {rank=same; FetchAQI; FetchWeather; EstimateTraffic}
    {rank=same; SourceAttr; Predictor; ActionEngine}
    {rank=same; AQICard; SourceViz; PredictionsChart; ActionCards; AlertsPanel}
}

